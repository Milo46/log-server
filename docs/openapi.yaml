openapi: 3.0.3
info:
  title: Log Server API
  description: |
    A lightweight HTTP-based schema-driven log sink service that allows users to define custom 
    log schemas and then receive JSON log entries validated against those schemas. This service 
    is designed for centralized logging in development environments and microservice architectures.
    
    ## Features
    - User-defined JSON schemas for log validation
    - Schema-validated log entry storage
    - PostgreSQL persistent storage with JSONB support
    - Filtering and pagination support
    - Health monitoring endpoint
    - Docker Compose deployment ready
    
    ## Workflow
    1. Register a JSON schema using POST /schemas
    2. Send log entries to POST /logs (with schema_id in the payload)
    3. All logs are validated against their schema before storage
    
  version: 1.0.0
  contact:
    name: Log Server Support
    url: https://github.com/your-org/log-server
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Development server
  - url: https://api.example.com
    description: Production server

paths:
  /:
    get:
      summary: Root health check endpoint
      description: |
        Returns the health status of the service.
        Alternative to /health endpoint.
      operationId: getRootStatus
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /schemas:
    post:
      summary: Create a new log schema
      description: |
        Registers a new JSON schema that will be used to validate log entries.
        The schema must be a valid JSON Schema Draft 7 specification.
      operationId: createSchema
      tags:
        - Schemas
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SchemaRequest'
            examples:
              web_server_schema:
                summary: Web server log schema
                value:
                  name: "web-server-logs"
                  version: "1.0.0"
                  description: "Schema for web server access logs"
                  schema_definition:
                    type: "object"
                    required: ["timestamp", "level", "message", "request_id"]
                    properties:
                      timestamp:
                        type: "string"
                        format: "date-time"
                      level:
                        type: "string"
                        enum: ["DEBUG", "INFO", "WARN", "ERROR"]
                      message:
                        type: "string"
                        minLength: 1
                      request_id:
                        type: "string"
                        pattern: "^[a-zA-Z0-9-]+$"
                      user_id:
                        type: "string"
                      response_time_ms:
                        type: "number"
                        minimum: 0
              error_tracking_schema:
                summary: Error tracking schema
                value:
                  name: "error-tracking"
                  version: "2.1.0"
                  description: "Schema for application error tracking"
                  schema_definition:
                    type: "object"
                    required: ["timestamp", "error_type", "message", "stack_trace"]
                    properties:
                      timestamp:
                        type: "string"
                        format: "date-time"
                      error_type:
                        type: "string"
                        enum: ["TypeError", "ReferenceError", "SyntaxError", "CustomError"]
                      message:
                        type: "string"
                      stack_trace:
                        type: "string"
                      user_context:
                        type: "object"
                        properties:
                          user_id:
                            type: "string"
                          session_id:
                            type: "string"
      responses:
        '201':
          description: Schema created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchemaResponse'
              example:
                id: "550e8400-e29b-41d4-a716-446655440000"
                name: "web-server-logs"
                version: "1.0.0"
                description: "Schema for web server access logs"
                schema_definition:
                  type: "object"
                  required: ["timestamp", "level", "message", "request_id"]
                  properties:
                    timestamp:
                      type: "string"
                      format: "date-time"
                    level:
                      type: "string"
                      enum: ["DEBUG", "INFO", "WARN", "ERROR"]
                created_at: "2025-10-23T09:00:00Z"
                updated_at: "2025-10-23T09:00:00Z"
        '400':
          description: Invalid JSON or missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "INVALID_SCHEMA"
                message: "Unexpected token at position 15"
        '422':
          description: Invalid JSON Schema specification
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "INVALID_SCHEMA"
                message: "Schema must be a valid JSON Schema Draft 7 specification"
        '409':
          description: Schema with the same name and version already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "SCHEMA_CONFLICT"
                message: "A schema with name 'web-server-logs' and version '1.0.0' already exists"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      summary: Retrieve schemas
      description: |
        Retrieves all registered schemas or filters by specific criteria.
        Results are returned with the most recently created schemas first.
      operationId: getSchemas
      tags:
        - Schemas
      parameters:
        - name: name
          in: query
          description: Filter schemas by exact name match
          required: false
          schema:
            type: string
        - name: version
          in: query
          description: Filter schemas by exact version match
          required: false
          schema:
            type: string
          schema:
            type: string
      responses:
        '200':
          description: Successfully retrieved schemas
          content:
            application/json:
              schema:
                type: object
                properties:
                  schemas:
                    type: array
                    items:
                      $ref: '#/components/schemas/SchemaResponse'
              example:
                schemas:
                  - id: "550e8400-e29b-41d4-a716-446655440000"
                    name: "web-server-logs"
                    version: "1.0.0"
                    description: "Schema for web server access logs"
                    schema_definition:
                      type: "object"
                      required: ["timestamp", "level", "message"]
                      properties:
                        timestamp:
                          type: "string"
                          format: "date-time"
                        level:
                          type: "string"
                          enum: ["DEBUG", "INFO", "WARN", "ERROR"]
                    created_at: "2025-10-23T09:00:00Z"
                    updated_at: "2025-10-23T09:00:00Z"
                  - id: "660f8500-f39c-52e5-b827-557766551001"
                    name: "error-tracking"
                    version: "2.1.0"
                    description: "Schema for application error tracking"
                    schema_definition:
                      type: "object"
                      required: ["error_type", "message"]
                      properties:
                        error_type:
                          type: "string"
                        message:
                          type: "string"
                    created_at: "2025-10-22T14:30:00Z"
                    updated_at: "2025-10-22T14:30:00Z"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /schemas/{id}:
    get:
      summary: Retrieve a specific schema
      description: Retrieves a single schema by its unique UUID, including the full schema definition.
      operationId: getSchemaById
      tags:
        - Schemas
      parameters:
        - name: id
          in: path
          required: true
          description: The unique UUID identifier of the schema
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Successfully retrieved schema
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchemaResponse'
        '404':
          description: Schema not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "NOT_FOUND"
                message: "Schema with id '550e8400-e29b-41d4-a716-446655440000' not found"

    put:
      summary: Update a schema
      description: Updates an existing schema by its UUID
      operationId: updateSchema
      tags:
        - Schemas
      parameters:
        - name: id
          in: path
          required: true
          description: The unique UUID identifier of the schema
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SchemaRequest'
      responses:
        '200':
          description: Schema updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchemaResponse'
        '404':
          description: Schema not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      summary: Delete a schema
      description: |
        Deletes a schema by its UUID. By default, schemas with associated logs cannot be deleted.
        Use the 'force' query parameter to delete schemas even when logs exist.
      operationId: deleteSchema
      tags:
        - Schemas
      parameters:
        - name: id
          in: path
          required: true
          description: The unique UUID identifier of the schema
          schema:
            type: string
            format: uuid
        - name: force
          in: query
          required: false
          description: Force deletion even when logs are associated with the schema
          schema:
            type: boolean
            default: false
      responses:
        '204':
          description: Schema deleted successfully
        '404':
          description: Schema not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "NOT_FOUND"
                message: "Schema with id '550e8400-e29b-41d4-a716-446655440000' not found"
        '409':
          description: Cannot delete schema because it has associated logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "SCHEMA_HAS_LOGS"
                message: "Cannot delete schema: 5 log(s) are associated with this schema"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /logs:
    post:
      summary: Create a new log entry
      description: |
        Accepts a JSON object representing a single log entry and validates it against 
        the specified schema before storing it in the database.
      operationId: createLogEntry
      tags:
        - Logs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: ["schema_id", "log_data"]
              properties:
                schema_id:
                  type: string
                  format: uuid
                  description: The UUID of the schema to validate against
                log_data:
                  type: object
                  description: The log data that must conform to the schema
            examples:
              web_server_log:
                summary: Web server access log
                value:
                  schema_id: "550e8400-e29b-41d4-a716-446655440000"
                  log_data:
                    timestamp: "2025-10-23T10:00:00Z"
                    level: "INFO"
                    message: "User login successful"
                    request_id: "req-12345"
      responses:
        '201':
          description: Log entry created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogEntryResponse'
              example:
                id: 123
                schema_id: "550e8400-e29b-41d4-a716-446655440000"
                log_data:
                  timestamp: "2025-10-23T10:00:00Z"
                  level: "INFO"
                  message: "User login successful"
                  request_id: "req-12345"
                created_at: "2025-10-23T10:00:00Z"
        '400':
          description: Invalid request format or missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Schema not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Log data validation failed against schema
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /logs/{id}:
    get:
      summary: Retrieve a specific log entry
      description: Retrieves a single log entry by its ID
      operationId: getLogById
      tags:
        - Logs
      parameters:
        - name: id
          in: path
          required: true
          description: The unique integer ID of the log entry
          schema:
            type: integer
      responses:
        '200':
          description: Successfully retrieved log entry
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogEntryResponse'
        '404':
          description: Log entry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      summary: Delete a log entry
      description: Deletes a log entry by its ID
      operationId: deleteLog
      tags:
        - Logs
      parameters:
        - name: id
          in: path
          required: true
          description: The unique integer ID of the log entry
          schema:
            type: integer
      responses:
        '204':
          description: Log entry deleted successfully
        '404':
          description: Log entry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "NOT_FOUND"
                message: "Log with id '123' not found"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /logs/schema/{schema_name}:
    get:
      summary: Get logs by schema name (default version)
      description: |
        Retrieves all log entries for a specific schema name using the default version (1.0.0).
        Supports filtering via query parameters.
      operationId: getLogsBySchemaName
      tags:
        - Logs
      parameters:
        - name: schema_name
          in: path
          required: true
          description: The name of the schema
          schema:
            type: string
        - name: level
          in: query
          description: Filter logs by level
          schema:
            type: string
        - name: limit
          in: query
          description: Maximum number of logs to return
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
      responses:
        '200':
          description: Successfully retrieved logs
          content:
            application/json:
              schema:
                type: object
                properties:
                  logs:
                    type: array
                    items:
                      $ref: '#/components/schemas/LogEntryResponse'
                  count:
                    type: integer
        '404':
          description: Schema not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /logs/schema/{schema_name}/{schema_version}:
    get:
      summary: Get logs by schema name and version
      description: |
        Retrieves all log entries for a specific schema name and version.
        Supports filtering via query parameters.
      operationId: getLogsBySchemaNameAndVersion
      tags:
        - Logs
      parameters:
        - name: schema_name
          in: path
          required: true
          description: The name of the schema
          schema:
            type: string
        - name: schema_version
          in: path
          required: true
          description: The version of the schema
          schema:
            type: string
        - name: level
          in: query
          description: Filter logs by level
          schema:
            type: string
        - name: limit
          in: query
          description: Maximum number of logs to return
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
      responses:
        '200':
          description: Successfully retrieved logs
          content:
            application/json:
              schema:
                type: object
                properties:
                  logs:
                    type: array
                    items:
                      $ref: '#/components/schemas/LogEntryResponse'
                  count:
                    type: integer
        '404':
          description: Schema not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /health:
    get:
      summary: Health check endpoint
      description: |
        Returns the health status of the service.
        Used by monitoring systems and load balancers.
      operationId: getHealthStatus
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "healthy"
                service: "log-server"
                timestamp: "2025-10-23T10:30:00Z"

components:
  schemas:
    SchemaRequest:
      type: object
      required:
        - name
        - version
        - schema_definition
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: Human-readable name for the schema
          example: "web-server-logs"
        version:
          type: string
          minLength: 1
          maxLength: 50
          description: Version of the schema
          example: "1.0.0"
        description:
          type: string
          maxLength: 1000
          description: Optional description of what this schema is used for
          example: "Schema for web server access logs"
        schema_definition:
          type: object
          description: Valid JSON Schema Draft 7 specification
          example:
            type: "object"
            required: ["message"]
            properties:
              message:
                type: "string"

    SchemaResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique UUID identifier for the schema
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          description: Human-readable name for the schema
          example: "web-server-logs"
        version:
          type: string
          description: Version of the schema
          example: "1.0.0"
        description:
          type: string
          nullable: true
          description: Optional description of the schema
          example: "Schema for web server access logs"
        schema_definition:
          type: object
          description: The JSON Schema definition
          example:
            type: "object"
            required: ["timestamp", "level", "message"]
            properties:
              timestamp:
                type: "string"
                format: "date-time"
              level:
                type: "string"
                enum: ["DEBUG", "INFO", "WARN", "ERROR"]
        created_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp when the schema was created
          example: "2025-10-23T09:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp when the schema was last updated
          example: "2025-10-23T09:00:00Z"

    LogEntryResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Unique identifier for the log entry
          example: 123
        schema_id:
          type: string
          format: uuid
          description: UUID of the schema this log entry was validated against
          example: "550e8400-e29b-41d4-a716-446655440000"
        log_data:
          type: object
          description: The actual log data that was validated against the schema
          additionalProperties: true
          example:
            message: "Test log message"
        created_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp when the log entry was stored
          example: "2025-10-23T10:00:01Z"

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          description: Health status of the service
          example: "healthy"
        service:
          type: string
          description: Name of the service
          example: "log-server"
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp when the health check was performed
          example: "2025-10-23T10:30:00Z"

    SchemaValidationErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: High-level error category
          example: "VALIDATION_FAILED"
        message:
          type: string
          description: Detailed error message
          example: "Log entry does not conform to schema"
        schema_id:
          type: string
          description: The UUID of the schema that was used for validation
          example: "550e8400-e29b-41d4-a716-446655440000"
        violations:
          type: array
          description: List of specific validation violations
          items:
            type: object
            properties:
              field:
                type: string
                description: The field that failed validation
                example: "request_id"
              message:
                type: string
                description: Description of the validation failure
                example: "Field is required but missing"

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: High-level error category
          example: "INVALID_INPUT"
        message:
          type: string
          description: Detailed error message
          example: "Schema name cannot be empty"
        field_errors:
          type: object
          description: Field-specific validation errors (optional)
          additionalProperties:
            type: array
            items:
              type: string
          example:
            name: ["Cannot be empty"]
            version: ["Invalid format"]

  examples:
    WebServerSchema:
      summary: Web server log schema
      value:
        name: "web-server-logs"
        version: "1.0.0"
        description: "Schema for web server access logs"
        schema_definition:
          type: "object"
          required: ["message"]
          properties:
            message:
              type: "string"

    ErrorTrackingSchema:
      summary: Error tracking schema
      value:
        name: "error-tracking"
        version: "2.1.0"
        description: "Schema for application error tracking"
        schema_definition:
          type: "object"
          required: ["message"]
          properties:
            message:
              type: "string"

    WebServerLogEntry:
      summary: Web server log entry
      value:
        message: "Test log message"

    ErrorLogEntry:
      summary: Error tracking log entry
      value:
        message: "Test error message"

tags:
  - name: Schemas
    description: Operations for managing log schemas
  - name: Logs
    description: Operations for managing log entries
  - name: Health
    description: Health monitoring endpoints

externalDocs:
  description: Find more info in the Software Requirements Document
  url: ./SRD.md
